name: Actualizar Tasa BCV

on:
  schedule:
    # 5 AM Venezuela (UTC-4) = 9 AM UTC
    - cron: '0 9 * * *'
    # 6:30 PM Venezuela (UTC-4) = 10:30 PM UTC
    - cron: '30 22 * * *'
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  update-bcv-rate:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch BCV Rate from API
        id: fetch-rate
        run: |
          echo "Fetching BCV rate from exchangedyn.com..."
          EUR_RATE=""

          # Try primary API (exchangedyn.com)
          RESPONSE=$(curl -s "https://api.exchangedyn.com/markets/quotes/usdves/bcv" \
            -H "Accept: application/json")

          if [ -n "$RESPONSE" ]; then
            RATE=$(echo "$RESPONSE" | jq -r '.sources.BCV.quote // empty')

            if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "" ]; then
              # Round to 2 decimals
              RATE=$(printf "%.2f" "$RATE")
              SOURCE="exchangedyn"
              DATE=$(date +%Y-%m-%d)

              # Also try to fetch euro rate from bcvapi.tech
              EUR_RESPONSE=$(curl -s "https://bcvapi.tech/api/v1/euro/public" -H "Accept: application/json" || true)
              if [ -n "$EUR_RESPONSE" ]; then
                EUR_RATE=$(echo "$EUR_RESPONSE" | jq -r '.valor // empty')
                if [ -n "$EUR_RATE" ] && [ "$EUR_RATE" != "null" ]; then
                  echo "Euro rate: $EUR_RATE"
                fi
              fi

              echo "rate=$RATE" >> $GITHUB_OUTPUT
              echo "source=$SOURCE" >> $GITHUB_OUTPUT
              echo "date=$DATE" >> $GITHUB_OUTPUT
              echo "eur_rate=$EUR_RATE" >> $GITHUB_OUTPUT
              echo "Success: Rate = $RATE from $SOURCE"
              exit 0
            fi
          fi

          echo "Primary API failed, trying fallback..."

          # Try fallback API (bcvapi.tech)
          RESPONSE=$(curl -s "https://bcvapi.tech/api/v1/dolar/public" \
            -H "Accept: application/json")

          if [ -n "$RESPONSE" ]; then
            RATE=$(echo "$RESPONSE" | jq -r '.valor // empty')

            if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "" ]; then
              SOURCE="bcvapi"
              DATE=$(date +%Y-%m-%d)

              # Also fetch euro rate since we're already using bcvapi
              EUR_RESPONSE=$(curl -s "https://bcvapi.tech/api/v1/euro/public" -H "Accept: application/json" || true)
              if [ -n "$EUR_RESPONSE" ]; then
                EUR_RATE=$(echo "$EUR_RESPONSE" | jq -r '.valor // empty')
                if [ -n "$EUR_RATE" ] && [ "$EUR_RATE" != "null" ]; then
                  echo "Euro rate: $EUR_RATE"
                fi
              fi

              echo "rate=$RATE" >> $GITHUB_OUTPUT
              echo "source=$SOURCE" >> $GITHUB_OUTPUT
              echo "date=$DATE" >> $GITHUB_OUTPUT
              echo "eur_rate=$EUR_RATE" >> $GITHUB_OUTPUT
              echo "Fallback success: Rate = $RATE from $SOURCE"
              exit 0
            fi
          fi

          echo "Both APIs failed!"
          exit 1

      - name: Update D1 Database via API
        if: steps.fetch-rate.outputs.rate != ''
        env:
          RPYM_API_URL: ${{ secrets.RPYM_API_URL }}
          RPYM_API_SECRET: ${{ secrets.RPYM_API_SECRET }}
          BCV_RATE: ${{ steps.fetch-rate.outputs.rate }}
          BCV_SOURCE: ${{ steps.fetch-rate.outputs.source }}
          BCV_DATE: ${{ steps.fetch-rate.outputs.date }}
          BCV_EUR_RATE: ${{ steps.fetch-rate.outputs.eur_rate }}
        run: |
          echo "Updating D1 with rate: $BCV_RATE (EUR: $BCV_EUR_RATE)"

          # Debug: Check if secrets are set
          if [ -z "$RPYM_API_URL" ]; then
            echo "ERROR: RPYM_API_URL secret is not set!"
            exit 1
          fi

          if [ -z "$RPYM_API_SECRET" ]; then
            echo "ERROR: RPYM_API_SECRET secret is not set!"
            exit 1
          fi

          # Trim whitespace from URL
          API_URL=$(echo "$RPYM_API_URL" | tr -d '[:space:]')
          echo "API URL: $API_URL/api/config/update-bcv"

          # Build JSON body with optional eurRate
          if [ -n "$BCV_EUR_RATE" ] && [ "$BCV_EUR_RATE" != "" ]; then
            JSON_BODY="{\"rate\": ${BCV_RATE}, \"source\": \"${BCV_SOURCE}\", \"date\": \"${BCV_DATE}\", \"eurRate\": ${BCV_EUR_RATE}}"
          else
            JSON_BODY="{\"rate\": ${BCV_RATE}, \"source\": \"${BCV_SOURCE}\", \"date\": \"${BCV_DATE}\"}"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}/api/config/update-bcv" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${RPYM_API_SECRET}" \
            -d "$JSON_BODY")

          # Extract HTTP status code (last line) and body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "API Response: $BODY"

          # Check if request was successful
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            SUCCESS=$(echo "$BODY" | jq -r '.success // false')
            if [ "$SUCCESS" = "true" ]; then
              echo "BCV rate updated successfully!"
              exit 0
            fi
          fi

          echo "Failed to update BCV rate (HTTP $HTTP_CODE)"
          exit 1
