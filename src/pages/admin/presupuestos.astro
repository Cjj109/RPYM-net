---
import Layout from '../../layouts/Layout.astro';
import AdminPanel from '../../components/AdminPanel';
import { getProducts, groupByCategory, getBCVRate } from '../../lib/sheets';
import { getD1 } from '../../lib/d1-types';

// SSR para datos frescos de D1
export const prerender = false;

// Obtener D1 database si está disponible
const db = getD1(Astro.locals);

// Obtener tasa BCV y productos (D1 primary, Google Sheets fallback)
const bcvRate = await getBCVRate();
const products = await getProducts(bcvRate.rate, db || undefined);
const categories = groupByCategory(products);
---

<Layout
  title="Admin - Presupuestos | RPYM"
  description="Panel de administración de presupuestos RPYM"
>
  <AdminPanel categories={categories} bcvRate={bcvRate} client:load />
</Layout>
